<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js ie6" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->  <html class="no-js" lang="en"> <!--<![endif]-->
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	
	<title></title>
	
	<meta name="description" content="A jQuery library for modern HTML presentations">
	<meta name="viewport" content="width=1024, user-scalable=no">
	
	<!-- Core and extension CSS files -->
	<link rel="stylesheet" href="../deck.js/core/deck.core.css">
	<link rel="stylesheet" href="../deck.js/extensions/goto/deck.goto.css">
	<link rel="stylesheet" href="../deck.js/extensions/menu/deck.menu.css">
	<link rel="stylesheet" href="../deck.js/extensions/navigation/deck.navigation.css">
	<link rel="stylesheet" href="../deck.js/extensions/status/deck.status.css">
	<link rel="stylesheet" href="../deck.js/extensions/hash/deck.hash.css">
	<link rel="stylesheet" href="../css/syntax.css">
	
	<!-- Theme CSS files (menu swaps these out) -->
    <link rel="stylesheet" href="../font-awesome/css/font-awesome.css">
    
    
	<link rel="stylesheet" id="style-theme-link" href="../themes/style/pivotal.css">
	<link rel="stylesheet" id="transition-theme-link" href="../deck.js/themes/transition/horizontal-slide.css">
	
	<script src="../deck.js/modernizr.custom.js"></script>
</head>

<body class="deck-container">

<div class="slide" id="slide1"><h1 id="toc_0">Security for Microservices with Spring</h1>

<p>Dave Syer, 2014<br>
Twitter: @david_syer<br>
Email: <a href="mailto:dsyer@pivotal.io">dsyer@pivotal.io</a></p>

<p>(Security for Microservices with Spring)</p>

</div><div class="slide" id="slide2"><h2 id="toc_1">Agenda</h2>

<ul>
<li>What is a Microservice?</li>
<li>How would it be secure?</li>
<li>If I was going to use Spring how would that look?</li>
<li>What&#39;s the easiest way to get something working?</li>
</ul>

</div><div class="slide" id="slide3"><h2 id="toc_2">Introduction</h2>

<ul>
<li>There&#39;s a <a href="http://www.indeed.com/jobtrends?q=JSON+REST%2CSOAP+XML&amp;l=&amp;relative=1#shareCode">strong trend</a> in distributed systems with
lightweight architectures</li>
<li>People have started to call them &quot;microservices&quot;</li>
</ul>

<p><img src="images/jobgraph_REST_SOAP_2014.png" alt="job-trends"></p>

<ul>
<li>So what are people doing about security in such systems?</li>
</ul>

</div><div class="slide" id="slide4"><h2 id="toc_3">What Are the Security Requirements</h2>

<blockquote>
<p>Stop bad guys from accessing your resources</p>
</blockquote>

<p>Identity and permissions:</p>

<ul>
<li>How is identity and permission information conveyed to a service?</li>
<li>How is it decoded and interpreted?</li>
<li>What data are needed to make the access decision (user accounts,
roles, ACLs etc.)?</li>
<li>How is the data managed: who is responsible for storing and
retrieving it?</li>
<li>How can you verify that the request hasn&#39;t been tampered with?</li>
</ul>

</div><div class="slide" id="slide5"><h2 id="toc_4">HTTP Basic Authentication</h2>

<ul>
<li>Something of a lowest common denominator</li>
<li>Supported on practically all servers natively and out of the box</li>
<li>Ubiquitous support on the client side in all languages</li>
<li>Good support in Spring Security</li>
<li>Spring Boot autoconfigures it out of the box</li>
</ul>

<p>Example:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">    $ curl &quot;https://$username:$password@myhost/resource&quot;
</code></pre></div>
</div><div class="slide" id="slide6"><h2 id="toc_5">Simple Service</h2>
<div class="highlight"><pre><code class="groovy language-groovy" data-lang="groovy"><span class="nd">@Grab</span><span class="o">(</span><span class="s1">&#39;spring-boot-starter-security&#39;</span><span class="o">)</span>
<span class="nd">@RestController</span>
<span class="kd">class</span> <span class="nc">Application</span> <span class="o">{</span>

   <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s2">&quot;/&quot;</span><span class="o">)</span>
   <span class="kt">def</span> <span class="nf">home</span><span class="o">()</span> <span class="o">{</span>
      <span class="o">[</span><span class="nl">status:</span> <span class="s1">&#39;OK&#39;</span><span class="o">]</span>
   <span class="o">}</span>

<span class="o">}</span>
</code></pre></div>
</div><div class="slide" id="slide7"><h2 id="toc_6">So what&#39;s wrong with that?</h2>

<ul>
<li>Nothing, but...</li>
<li>Where do you get the credentials (the username and password)?</li>
<li>Fine for systems where all participants can share secrets securely</li>
<li>In practice that means small systems</li>
<li>Only supports username/password</li>
<li>Only covers authentication</li>
<li>No distinction between users and machines</li>
</ul>

</div><div class="slide" id="slide8"><h2 id="toc_7">Certificate Based Security</h2>

<ul>
<li>Set up SSL on server so that request has to contain certificate</li>
<li>Spring Security (X.509) can turn that into an <code>Authentication</code></li>
<li>If SSL is in the service layer (i.e. not at the router/loadbalancer)
then you have a keystore anyway</li>
</ul>

<p>Example:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">$ curl -k --cert rod.pem:password https://localhost:8443/hello
</code></pre></div>
<p><br/>
<a href="https://github.com/SpringOne2GX-2014/microservice-security/tree/master/certs">https://github.com/SpringOne2GX-2014/microservice-security/tree/master/certs</a></p>

</div><div class="slide" id="slide9"><h2 id="toc_8">So what&#39;s wrong with that?</h2>

<ul>
<li>Nothing, but...</li>
<li>There&#39;s no user identity (only at most the machine) unless browsers
have certificates installed</li>
<li>Requires keystores and certificates in all applications and services
(significantly non-trivial if done properly, but some organizations
require it anyway)</li>
<li>No fine distinction between users and machines</li>
</ul>

</div><div class="slide" id="slide10"><h2 id="toc_9">Custom Authentication Token</h2>

<ul>
<li>Random identifier per authentication</li>
<li>Grant them from a central service and/or store in a central database</li>
<li>Can be exposed directly via developer UI</li>
<li>Re-hydrate authentication in service</li>
<li>Spring Security <code>AbstractPreAuthenticatedProcessingFilter</code> and friends</li>
<li>Even easier: Spring Session identifier</li>
<li>Github example: token is temporary password in HTTP Basic</li>
</ul>

<p><a href="https://github.com/SpringOne2GX-2014/microservice-security/tree/master/pairs/spring-session">https://github.com/SpringOne2GX-2014/microservice-security/tree/master/pairs/spring-session</a></p>

</div><div class="slide" id="slide11"><h2 id="toc_10">So what&#39;s wrong with that?</h2>

<ul>
<li>Nothing, but...</li>
<li>No separation of client app from user authentication</li>
<li>Coarse grained authorization (all tokens activate all resources)</li>
<li>It&#39;s not a &quot;standard&quot; (but there are ready made implementations)</li>
<li>For user authentication, need to collect user credentials in app</li>
</ul>

</div><div class="slide" id="slide12"><h2 id="toc_11">OAuth2 Key Features</h2>

<ul>
<li>IETF standard</li>
<li>Extremely simple for clients (and developers)</li>
<li>Access tokens carry information (beyond identity)</li>
<li>Clear separation between users and machines</li>
<li>Strong emphasis on not collecting user credentials in client app</li>
<li>Machines act on their own or on behalf of users</li>
<li>Resources are free to interpret token content</li>
</ul>

</div><div class="slide" id="slide13"><h2 id="toc_12">So what&#39;s wrong with that?</h2>

<ul>
<li>Nothing, but...</li>
<li>No standard (yet) for request signing</li>
</ul>

</div><div class="slide" id="slide14"><h2 id="toc_13">OAuth2 and the Microservice</h2>

<p>Example command line Client:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">$ curl -H &quot;Authorization: Bearer $TOKEN&quot; https://myhost/resource
</code></pre></div>
<ul>
<li><code>https://myhost</code> is a Resource Server</li>
<li><code>TOKEN</code> is a Bearer Token</li>
<li>it came from an Authorization Server</li>
</ul>

</div><div class="slide" id="slide15"><h2 id="toc_14">Simple Resource Server</h2>
<div class="highlight"><pre><code class="groovy language-groovy" data-lang="groovy"><span class="nd">@EnableResourceServer</span>
<span class="kd">class</span> <span class="nc">ResourceServer</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="n">JwtTokenStore</span> <span class="nf">tokenStore</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">JwtAccessTokenConverter</span> <span class="n">enhancer</span> <span class="o">=</span> 
            <span class="k">new</span> <span class="nf">JwtAccessTokenConverter</span><span class="o">()</span>
        <span class="n">enhancer</span><span class="o">.</span><span class="na">afterPropertiesSet</span><span class="o">()</span>
        <span class="k">new</span> <span class="nf">JwtTokenStore</span><span class="o">(</span><span class="n">enhancer</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<blockquote>
<p>N.B. in a real system you would have to configure the verifierKey
(or use JdbcTokenStore)</p>
</blockquote>

</div><div class="slide" id="slide16"><h2 id="toc_15">Simple Authorization Server</h2>
<div class="highlight"><pre><code class="groovy language-groovy" data-lang="groovy"><span class="nd">@EnableAuthorizationServer</span>
<span class="kd">class</span> <span class="nc">AuthorizationServer</span> <span class="kd">extends</span> <span class="n">AuthorizationServerConfigurerAdapter</span> <span class="o">{</span>

   <span class="nd">@Override</span>
   <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">ClientDetailsServiceConfigurer</span> <span class="n">clients</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
      <span class="n">clients</span><span class="o">.</span><span class="na">inMemory</span><span class="o">()</span>
         <span class="o">.</span><span class="na">withClient</span><span class="o">(</span><span class="s2">&quot;my-client-with-secret&quot;</span><span class="o">)...</span>
   <span class="o">}</span>

<span class="o">}</span>
</code></pre></div>
</div><div class="slide" id="slide17"><h2 id="toc_16">Example token contents</h2>

<ul>
<li>Client id</li>
<li>Resource id (audience)</li>
<li>Issuer</li>
<li>User id</li>
<li>Role assignments</li>
</ul>

</div><div class="slide" id="slide18"><h2 id="toc_17">JWT Bearer Tokens</h2>

<ul>
<li>OAuth 2.0 tokens are opaque to clients</li>
<li>But they carry important information to Resource Servers</li>
<li><p>Example of implementation (from Cloud Foundry UAA, JWT = signed,
base64-encoded, JSON):</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">{  &quot;client_id&quot;:&quot;cf&quot;,
   &quot;exp&quot;:1346325625,
   &quot;scope&quot;:[&quot;cloud_controller.read&quot;,&quot;openid&quot;,&quot;password.write&quot;],
   &quot;aud&quot;:[&quot;openid&quot;,&quot;cloud_controller&quot;,&quot;password&quot;],
   &quot;iss&quot;: &quot;https://login.run.pivotal.io&quot;,
   &quot;user_name&quot;:&quot;tester@vmware.com&quot;,
   &quot;user_id&quot;:&quot;52147673-9d60-4674-a6d9-225b94d7a64e&quot;,
   &quot;email&quot;:&quot;tester@vmware.com&quot;,
   &quot;jti&quot;:&quot;f724ae9a-7c6f-41f2-9c4a-526cea84e614&quot; }
</code></pre></div></li>
</ul>

</div><div class="slide" id="slide19"><h2 id="toc_18">OAuth2 and the Microservice</h2>

<ul>
<li>Resource Servers might be microservices</li>
<li>Web app clients: authorization code grant</li>
<li>Browser clients (single page app): authorization code grant (better) or implicit grant</li>
<li>Mobile and non-browser clients: password grant (maybe with mods for multifactor etc.)</li>
<li>Service clients (intra-system): client credentials or relay user token</li>
</ul>

</div><div class="slide" id="slide20"><h2 id="toc_19">Spring Cloud Security</h2>

<blockquote>
<p>A further level of abstraction to make common microservice security
use cases really easy to implement</p>
</blockquote>

<ul>
<li>Convention over configuration</li>
<li>UX for deployment on Cloud Foundry very smooth</li>
</ul>

</div><div class="slide" id="slide21"><h2 id="toc_20">Simple SSO Client</h2>
<div class="highlight"><pre><code class="groovy language-groovy" data-lang="groovy"><span class="nd">@EnableOAuth2Sso</span>
<span class="nd">@Controller</span>
<span class="kd">class</span> <span class="nc">Demo</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre></div><div class="highlight"><pre><code class="text language-text" data-lang="text">$ spring jar app.jar app.groovy
$ cf push -p app.jar
</code></pre></div>
<p>(That&#39;s it.)</p>

</div><div class="slide" id="slide22"><h2 id="toc_21">How Does that Work?</h2>

<p>Answer: configuration conventions. The app was bound to a service</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">$ cf bind-service app sso
</code></pre></div>
<p>and the service provides credentials.</p>

<p>To create the same bindings manually (e.g. in <code>application.yml</code>):</p>
<div class="highlight"><pre><code class="yaml language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">oauth2</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">client</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">tokenUri</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://login.run.pivotal.io/oauth/token</span>
    <span class="l-Scalar-Plain">authorizationUri</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://login.run.pivotal.io/oauth/authorize</span>
    <span class="l-Scalar-Plain">clientId</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">acme</span>
    <span class="l-Scalar-Plain">clientSecret</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">${CLIENT_SECRET}</span>
  <span class="l-Scalar-Plain">resource</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">tokenInfoUri</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://uaa.run.pivotal.io/check_token</span>
    <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">openid</span>
    <span class="l-Scalar-Plain">serviceId</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">${PREFIX:}resource</span>
</code></pre></div>
</div><div class="slide" id="slide23"><h2 id="toc_22">Resource Server with Spring Cloud</h2>
<div class="highlight"><pre><code class="groovy language-groovy" data-lang="groovy"><span class="nd">@EnableOAuth2Resource</span>
<span class="nd">@EnableEurekaClient</span>
<span class="nd">@RestController</span>
<span class="kd">class</span> <span class="nc">Demo</span> <span class="o">{</span>
  <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s2">&quot;/&quot;</span><span class="o">)</span>
  <span class="kt">def</span> <span class="nf">home</span><span class="o">()</span> <span class="o">{</span> <span class="o">[</span><span class="nl">id:</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span> <span class="nl">content:</span> <span class="s2">&quot;Hello Remote&quot;</span><span class="o">]</span> <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>How does it work? Same as <code>@EnableOAuth2Sso</code> (bind to service
providing credentials for conventional external configuration).</p>

</div><div class="slide" id="slide24"><h2 id="toc_23">Single Page Apps</h2>

<p>With backend services CORS restrictions make reverse proxy useful (<code>@EnableZuulProxy</code>).
Then you can acquire tokens in the client app and relay them to back end.</p>

<p>With no backend services, don&#39;t be shy, <strong>use the session</strong> (authorization code flow is vastly
superior).</p>

<p><a href="https://github.com/spring-projects/spring-session">Spring Session</a> helps a lot too.</p>

</div><div class="slide" id="slide25"><h2 id="toc_24">Relaying User Tokens</h2>

<blockquote>
<p>Front end app sends SSO token with user credentials to authenticate
back end requests, back ends just relay it to each other as
necessary.</p>
</blockquote>

<p>Simple but possibly flawed: the front end only needs access to user
details to authenticate, but you need to give it permission to do
other things to allow it access to the back ends.</p>

<p>Idea: exchange (with full authentication) the incoming token for an
outgoing one with different permissions (client but not scope). Can
use password grant (e.g. with the incoming token as a password).</p>

</div><div class="slide" id="slide26"><h2 id="toc_25">Token Relay with Spring Cloud</h2>
<div class="highlight"><pre><code class="groovy language-groovy" data-lang="groovy"><span class="nd">@EnableOAuth2Sso</span>
<span class="nd">@EnableZuulProxy</span>
<span class="nd">@Controller</span>
<span class="kd">class</span> <span class="nc">Demo</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre></div>
<ul>
<li>Autoconfiguration for <code>@EnableZuulProxy</code> combined with <code>@EnableOAuth2Sso</code></li>
<li>Adds <code>ZuulFilter</code> that attaches the current user token to downstream requests</li>
</ul>

</div><div class="slide" id="slide27"><h2 id="toc_26">Other Options</h2>

<ul>
<li>OAuth 1.0</li>
<li>SAML assertions</li>
<li>Physical network security IP tables etc.</li>
<li>Kerberos</li>
<li>Combinations of the above (including OAuth 2.0)</li>
</ul>

</div><div class="slide" id="slide28"><h2 id="toc_27">In Conclusion</h2>

<ul>
<li>Lightweight services demand lightweight infrastructure</li>
<li>Security is important, but should be unobtrusive</li>
<li>Spring Security and Spring Cloud make it all easier</li>
<li>Special mention for Spring Session</li>
<li>OAuth 2.0 is a standard, and has a lot of useful features</li>
<li><a href="http://github.com/springsource/spring-security-oauth">Spring Security OAuth</a> aims to be a complete OAuth2
solution at the framework level</li>
<li>Cloudfoundry has an open source, OAuth2 identity service (UAA)</li>
</ul>

</div><div class="slide" id="slide29"><h2 id="toc_28">Links</h2>

<ul>
<li><a href="https://github.com/spring-projects/spring-security-oauth">https://github.com/spring-projects/spring-security-oauth</a></li>
<li><a href="https://github.com/spring-projects/spring-security-oauth/tree/master/tests/annotation">https://github.com/spring-projects/spring-security-oauth/tree/master/tests/annotation</a></li>
<li><a href="https://github.com/spring-cloud/spring-cloud-security">https://github.com/spring-cloud/spring-cloud-security</a></li>
<li><a href="https://github.com/spring-cloud-samples/scripts">http://github.com/spring-cloud-samples/scripts</a></li>
<li><a href="https://github.com/SpringOne2GX-2014/microservice-security">https://github.com/SpringOne2GX-2014/microservice-security</a></li>
<li><a href="https://github.com/cloudfoundry/uaa">https://github.com/cloudfoundry/uaa</a></li>
<li><a href="http://blog.spring.io">http://blog.spring.io</a></li>
<li><a href="http://blog.cloudfoundry.org">http://blog.cloudfoundry.org</a></li>
<li><a href="http://presos.dsyer.com/decks/microservice-security.html">http://presos.dsyer.com/decks/microservice-security.html</a></li>
<li>Twitter: @david_syer<br></li>
<li>Email: <a href="mailto:dsyer@pivotal.io">dsyer@pivotal.io</a></li>
</ul>
</div>


<a href="#" class="deck-prev-link" title="Previous">&#8592;</a>
<a href="#" class="deck-next-link" title="Next">&#8594;</a>

<p id="footer" class="deck-status">
	<span class="deck-status-current"></span>/<span class="deck-status-total"></span>
</p>

<form action="." method="get" class="goto-form">
	<label for="goto-slide">Go to slide:</label>
	<input type="number" name="slidenum" id="goto-slide">
	<input type="submit" value="Go">
</form>

<a href="." title="Permalink to this slide" class="deck-permalink">#</a>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.js"></script>
<script>window.jQuery || document.write('<script src="../deck.js/jquery.min.js"><\/script>')</script>

<!-- Deck Core and extensions -->
<script src="../deck.js/core/deck.core.js"></script>
<script src="../deck.js/extensions/menu/deck.menu.js"></script>
<script src="../deck.js/extensions/goto/deck.goto.js"></script>
<script src="../deck.js/extensions/status/deck.status.js"></script>
<script src="../deck.js/extensions/navigation/deck.navigation.js"></script>
<script src="../deck.js/extensions/hash/deck.hash.js"></script>

<script type="text/javascript">
$(function() {
	// Deck initialization
	$.deck('.slide');
	
	$('#style-themes').change(function() {
		$('#style-theme-link').attr('href', $(this).val());
	});
	
	$('#transition-themes').change(function() {
		$('#transition-theme-link').attr('href', $(this).val());
	});

    $('pre').click(function (){
	$(this).toggleClass('highlighted');
    });
});
</script>

</body>
</html>
