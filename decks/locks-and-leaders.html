
<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js ie6" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->  <html class="no-js" lang="en"> <!--<![endif]-->
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	
	<title></title>
	
	<meta name="description" content="A jQuery library for modern HTML presentations">
	<meta name="viewport" content="width=1024, user-scalable=no">
	
	<!-- Core and extension CSS files -->
	<link rel="stylesheet" href="../deck.js/core/deck.core.css">
	<link rel="stylesheet" href="../deck.js/extensions/goto/deck.goto.css">
	<link rel="stylesheet" href="../deck.js/extensions/menu/deck.menu.css">
	<link rel="stylesheet" href="../deck.js/extensions/navigation/deck.navigation.css">
	<link rel="stylesheet" href="../deck.js/extensions/status/deck.status.css">
	<link rel="stylesheet" href="../deck.js/extensions/hash/deck.hash.css">
	<link rel="stylesheet" href="../css/syntax.css">
	
	<!-- Theme CSS files (menu swaps these out) -->
    <link rel="stylesheet" href="../font-awesome/css/font-awesome.css">
    
    
	<link rel="stylesheet" id="style-theme-link" href="../themes/style/spring.css">
	<link rel="stylesheet" id="transition-theme-link" href="../deck.js/themes/transition/fade.css">
	
	<script src="../deck.js/modernizr.custom.js"></script>
</head>

<body class="deck-container">

<div class="slide" id="slide1"><h1 id="locks-and-leaders-with-spring-integration">Locks and Leaders with Spring Integration</h1>

<p>Dave Syer, 2016<br>
Twitter: @david_syer (see also @artem_bilan, @gprussell)<br>
Email: <code>dsyer@pivotal.io</code></p>

</div><div class="slide" id="slide2"><h2 id="agenda">Agenda</h2>

<ul>
<li>What is a distributed lock?</li>
<li>What is a leader election?</li>
<li>What is it good for?</li>
<li>How do I do it?</li>
<li>Some tools for thinking about failure</li>
</ul>

<blockquote>
<p>Warning: Here be Dragons!</p>
</blockquote>

</div><div class="slide" id="slide3"><h2 id="a-simple-distributed-operation">A Simple Distributed Operation</h2>

<p><img src="images/locks-basic-sequence-0.png" alt="basic-sequence-0"></p>

</div><div class="slide" id="slide4"><h2 id="two-clients">Two Clients</h2>

<p><img src="images/locks-basic-sequence-1.png" alt="basic-sequence-1"></p>

</div><div class="slide" id="slide5"><h2 id="shuffle">Shuffle!</h2>

<p><img src="images/locks-basic-sequence-2.png" alt="basic-sequence-2"></p>

</div><div class="slide" id="slide6"><h2 id="shuffle">Shuffle!</h2>

<p><img src="images/locks-basic-sequence-3.png" alt="basic-sequence-3"></p>

</div><div class="slide" id="slide7"><h2 id="shuffle">Shuffle!</h2>

<p><img src="images/locks-basic-sequence-4.png" alt="basic-sequence-4"></p>

</div><div class="slide" id="slide8"><h2 id="shuffle">Shuffle!</h2>

<p><img src="images/locks-basic-sequence-2.png" alt="basic-sequence-4"></p>

</div><div class="slide" id="slide9"><h2 id="shuffle">Shuffle!</h2>

<p><img src="images/locks-basic-sequence-1.png" alt="basic-sequence-4"></p>

</div><div class="slide" id="slide10"><h2 id="shuffle">Shuffle!</h2>

<p><img src="images/locks-basic-sequence-3.png" alt="basic-sequence-4"></p>

</div><div class="slide" id="slide11"><h2 id="scary-eh">Scary, Eh?</h2>

<p><img src="images/locks-basic-sequence-5.png" alt="basic-sequence-5"></p>

</div><div class="slide" id="slide12"><h2 id="locks">Locks</h2>

<p>Example code using <code>java.util.concurrent.locks.Lock</code>:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kt">boolean</span> <span class="n">acquired</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="k">try</span> <span class="o">{</span>
  <span class="n">acquired</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">acquired</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Do something unique!</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">&quot;Interrupted&quot;</span><span class="o">);</span>
<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">acquired</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
</div><div class="slide" id="slide13"><h2 id="spring-integration-lockregistry">Spring Integration: LockRegistry</h2>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">LockRegistry</span> <span class="o">{</span>
    <span class="n">Lock</span> <span class="nf">obtain</span><span class="o">(</span><span class="n">Object</span> <span class="n">lockKey</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>
</div><div class="slide" id="slide14"><h2 id="locks-with-spring-integration">Locks with Spring Integration</h2>

<p>Example code using <code>LockRegistry</code>:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kt">boolean</span> <span class="n">acquired</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
<span class="k">try</span> <span class="o">{</span>
  <span class="n">acquired</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">acquired</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Do something unique!</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">&quot;Interrupted&quot;</span><span class="o">);</span>
<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">acquired</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>(same code)</p>

</div><div class="slide" id="slide15"><h2 id="locks-and-leases">Locks and Leases</h2>

<p>A distributed lock nearly always has a shelf life (it expires).</p>

<p>Technically, that makes it a &quot;lease&quot;.</p>

<p>Without expiry system can&#39;t make progress when a lock holder dies.</p>

</div><div class="slide" id="slide16"><h2 id="dragons">Dragons</h2>

<p>(At least) two problems are lurking:</p>

<ol>
<li>Acquiring a lock requires consensus.</li>
<li>Leases expire and holder can never be sure when that happens.</li>
</ol>

<p><strong>Read this</strong>:
  <a href="http://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html">http://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html</a></p>

<p>TL;DR If using a lock for &quot;correctness&quot; not &quot;efficiency&quot; be <em>very</em> careful.</p>

</div><div class="slide" id="slide17"><h2 id="public-service-announcement">Public Service Announcement</h2>

<blockquote>
<p>Important: you can tune the system to adjust the probability, or how
long it lasts, but fundamentally you cannot prevent the system from
ever allowing more than one holder of a lock.</p>
</blockquote>

</div><div class="slide" id="slide18"><h2 id="leader-elections">Leader Elections</h2>

<blockquote>
<p>Simple idea: if you hold a lock you are the leader.</p>
</blockquote>

<p>What can you do with it?</p>

<blockquote>
<p>Highly available globally unique things, often with messages</p>
</blockquote>

<ul>
<li>sequences</li>
<li>message aggregation</li>
<li>scheduling, e.g. cron service</li>
</ul>

</div><div class="slide" id="slide19"><h2 id="spring-integration-leader-initiator">Spring Integration: Leader Initiator</h2>

<p>Implementations of leader election need to be able to start an
election and fire events on granted and revoked.</p>

<ul>
<li>Zookeeper</li>
<li>Hazelcast</li>
<li>Etcd(*)</li>
<li>Generic (lock-based)</li>
</ul>

<p>For a user it looks like this (create a new bean which is a <code>SmartLifecycle</code>):</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">LeaderInitiator</span> <span class="nf">leaderInitiator</span><span class="o">(</span><span class="n">CuratorFramework</span> <span class="n">client</span><span class="o">,</span>
            <span class="n">Candidate</span> <span class="n">candidate</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nf">LeaderInitiator</span><span class="o">(</span><span class="n">client</span><span class="o">,</span> <span class="n">candidate</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>
<p>(*) No support for etcd v3. Probably dead.</p>

</div><div class="slide" id="slide20"><h2 id="spring-integration-callbacks">Spring Integration: Callbacks</h2>

<p>Callbacks on leadership events:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Candidate</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">onGranted</span><span class="o">(</span><span class="n">Context</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">;</span>
    <span class="kt">void</span> <span class="nf">onRevoked</span><span class="o">(</span><span class="n">Context</span> <span class="n">ctx</span><span class="o">);</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div>
<p>See also:</p>
<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@EventListener</span><span class="o">(</span><span class="n">OnGrantedEvent</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>

<span class="o">}</span>

<span class="nd">@EventListener</span><span class="o">(</span><span class="n">OnRevokedEvent</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">()</span> <span class="o">{</span>

<span class="o">}</span>
</code></pre></div>
</div><div class="slide" id="slide21"><h2 id="closing">Closing</h2>

<ul>
<li><p>When to use locks and leaders: HA active/passive failover</p></li>
<li><p>How to avoid it: latency from restarting a failed app might be fine</p></li>
<li><p>Otherwise, be idempotent. For correctness, de-duplication store has to be ACID.</p></li>
<li><p>Relational databases can be really useful, as is Zookeeper.</p></li>
<li><p>Careful with the physics.</p></li>
</ul>

</div><div class="slide" id="slide22"><h2 id="links">Links</h2>

<ul>
<li><a href="http://presos.dsyer.com/decks/locks-and-leaders.html">http://presos.dsyer.com/decks/locks-and-leaders.html</a></li>
<li>Sample code: <a href="https://github.com/SpringOnePlatform2016/dsyer-locks-and-leaders">https://github.com/SpringOnePlatform2016/dsyer-locks-and-leaders</a></li>
<li>Spring Integration: <a href="https://github.com/spring-projects/spring-integration">https://github.com/spring-projects/spring-integration</a></li>
<li>Spring Cloud Cluster: <a href="https://github.com/spring-cloud/spring-cloud-cluster">https://github.com/spring-cloud/spring-cloud-cluster</a></li>
</ul>
</div>

<a href="#" class="deck-prev-link" title="Previous">&#8592;</a>
<a href="#" class="deck-next-link" title="Next">&#8594;</a>

<p id="footer" class="deck-status">
	<span class="deck-status-current"></span>/<span class="deck-status-total"></span>
</p>

<form action="." method="get" class="goto-form">
	<label for="goto-slide">Go to slide:</label>
	<input type="number" name="slidenum" id="goto-slide">
	<input type="submit" value="Go">
</form>

<a href="." title="Permalink to this slide" class="deck-permalink">#</a>

<script src="/deck.js/jquery-1.7.2.min.js"></script>
<script>window.jQuery || document.write('<script src="../deck.js/jquery.min.js"><\/script>')</script>

<!-- Deck Core and extensions -->
<script src="../deck.js/core/deck.core.js"></script>
<script src="../deck.js/extensions/menu/deck.menu.js"></script>
<script src="../deck.js/extensions/goto/deck.goto.js"></script>
<script src="../deck.js/extensions/status/deck.status.js"></script>
<script src="../deck.js/extensions/navigation/deck.navigation.js"></script>
<script src="../deck.js/extensions/hash/deck.hash.js"></script>

<script type="text/javascript">
$(function() {
	// Deck initialization
	$.deck('.slide');
	
	$('#style-themes').change(function() {
		$('#style-theme-link').attr('href', $(this).val());
	});
	
	$('#transition-themes').change(function() {
		$('#transition-theme-link').attr('href', $(this).val());
	});

    $('pre').click(function (){
	$(this).toggleClass('highlighted');
    });
});
</script>

</body>
</html>
