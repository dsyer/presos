
<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js ie6" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->  <html class="no-js" lang="en"> <!--<![endif]-->
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	
	<title></title>
	
	<meta name="description" content="A jQuery library for modern HTML presentations">
	<meta name="viewport" content="width=1024, user-scalable=no">
	
	<!-- Core and extension CSS files -->
	<link rel="stylesheet" href="../deck.js/core/deck.core.css">
	<link rel="stylesheet" href="../deck.js/extensions/goto/deck.goto.css">
	<link rel="stylesheet" href="../deck.js/extensions/menu/deck.menu.css">
	<link rel="stylesheet" href="../deck.js/extensions/navigation/deck.navigation.css">
	<link rel="stylesheet" href="../deck.js/extensions/status/deck.status.css">
	<link rel="stylesheet" href="../deck.js/extensions/hash/deck.hash.css">
	<link rel="stylesheet" href="../css/syntax.css">
	
	<!-- Theme CSS files (menu swaps these out) -->
    <link rel="stylesheet" href="../font-awesome/css/font-awesome.css">
    
    
	<link rel="stylesheet" id="style-theme-link" href="../themes/style/web-2.0.css">
	<link rel="stylesheet" id="transition-theme-link" href="../deck.js/themes/transition/fade.css">
	
	<script src="../deck.js/modernizr.custom.js"></script>
</head>

<body class="deck-container">

<div class="slide" id="slide1"><h1 id="distributed-tracing-with-spring-cloud">Distributed Tracing with Spring Cloud</h1>

<p>Dave Syer, 2016<br>
Twitter: @david_syer<br>
Email: <code>dsyer@pivotal.io</code></p>

</div><div class="slide" id="slide2"><h2 id="agenda">Agenda</h2>

<ul>
<li>What is a correlated log?</li>
<li>What is Distributed Tracing?</li>
<li>Why do I care?</li>
<li>How do I do it?</li>
</ul>

</div><div class="slide" id="slide3"><h2 id="correlation">Correlation</h2>

<p>Add a Correlation ID to logs, and propagate it between
processes (e.g. in HTTP or message headers)</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">2016-03-05 12:07:03.748 INFO [service1,5b7b3ceafd06fceb,5b7b3ceafd06fceb,false] 18487 --- ...
2016-03-05 12:07:03.748 INFO [service1,5b7b3ceafd06fceb,5b7b3ceafd06fceb,false] 18487 --- ...
2016-03-05 12:07:05.540 INFO [service2,5b7b3ceafd06fceb,162e2f236273a756,false] 18487 --- ...
2016-03-05 12:07:05.541 INFO [service2,5b7b3ceafd06fceb,162e2f236273a756,false] 18487 --- ...
</code></pre></div>
<blockquote>
<p>Correlated logs are a building block.</p>
</blockquote>

<p>You can answer a lot of questions just with
standard log analysis tools (ELK, Splunk, etc.)</p>

</div><div class="slide" id="slide4"><h2 id="spring-cloud-sleuth">Spring Cloud Sleuth</h2>

<p><em>Recipe:</em></p>

<ul>
<li>Take any Spring Boot application</li>
<li>Add <em>spring-cloud-sleuth</em></li>
<li>Logs ahoy!</li>
</ul>

</div><div class="slide" id="slide5"><h2 id="adding-a-log-analayser">Adding a Log Analayser</h2>

<ul>
<li><p>Apps send logs (stdout) to a central service</p></li>
<li><p>Parsing and analysis and visualization</p></li>
<li><p>Correlation ID -&gt; unified view of business event</p></li>
<li><p>Examples: E(lastic Search)L(ogstash)K(ibana),
Splunk, Sumologic, Papertrail, ...</p></li>
</ul>

<style>
img[alt=KibanaUI] { width: 50%; }
</style>

<p><img src="images/kibana.png" alt="KibanaUI"></p>

</div><div class="slide" id="slide6"><h2 id="distributed-tracing">Distributed Tracing</h2>

<blockquote>
<p>Why is this POST /thing so slow?</p>
</blockquote>
<div class="highlight"><pre><code class="language-text" data-lang="text">           +-------------------------------------+
           |  POST /thing                        |
           +-------------------------------------+
</code></pre></div>
</div><div class="slide" id="slide7"><h2 id="troubleshooting-latency-problems">Troubleshooting Latency Problems</h2>

<ul>
<li>When was the request and how long did it take?</li>
<li>Where did it happen?</li>
<li>Which request or business event was it?</li>
<li>Is it abnormal?</li>
</ul>

</div><div class="slide" id="slide8"><h2 id="when-was-it-and-how-long-did-it-take">When was it and how long did it take?</h2>
<div class="highlight"><pre><code class="language-text" data-lang="text">           Server Received: 15:31:29:103         Server Sent: 15:31:30:530
           v                                     v
           +-------------------------------------+
           |  POST /thing                        | 1427ms
           +-------------------------------------+
</code></pre></div>
<blockquote>
<p>First log statement: 15:31:29:103, last one: 15:31:30:530</p>
</blockquote>

</div><div class="slide" id="slide9"><h2 id="where-did-this-happen">Where did this happen?</h2>
<div class="highlight"><pre><code class="language-text" data-lang="text">           Server Received: 15:31:29:103         Server Sent: 15:31:30:530
           v                                     v
           +-------------------------------------+
           |  POST /thing                        | 1427ms
           +-------------------------------------+
                            | peer.ipv4 | 1.2.3.4 |
</code></pre></div>
<blockquote>
<p>Server is a shard in the wombat cluster, listening on <em>10.2.3.4:8080</em></p>

<p>Server log says Client IP was <em>1.2.3.4</em></p>
</blockquote>

</div><div class="slide" id="slide10"><h2 id="which-business-event-was-it">Which Business Event Was It?</h2>
<div class="highlight"><pre><code class="language-text" data-lang="text">           Server Received: 15:31:29:103         Server Sent: 15:31:30:530
           v                                     v
           +-------------------------------------+
           |  POST /thing                        | 1427ms
           +-------------------------------------+
                            | peer.ipv4       | 1.2.3.4  |
                            | http.request-id | abcd-ffe |
</code></pre></div>
<blockquote>
<p>The http response header had <em>request-id: abcd-ffe</em>? Is that what you mean?</p>
</blockquote>

</div><div class="slide" id="slide11"><h2 id="is-it-abnormal">Is it Abnormal?</h2>
<div class="highlight"><pre><code class="language-text" data-lang="text">           Server Received: 15:31:29:103         Server Sent: 15:31:30:530
           v                                     v
           +-------------------------------------+
           |  POST /thing                        | 1427ms
           +-------------------------------------+
                            | peer.ipv4       | 1.2.3.4  |
                            | http.request-id | abcd-ffe |
</code></pre></div>
<blockquote>
<p>Well, average response time for <em>POST /things</em> in the last 2 days is <em>100ms</em></p>

<p>I’ll check other logs for this request id and see what I can find out.</p>
</blockquote>

</div><div class="slide" id="slide12"><h2 id="achieving-understanding">Achieving Understanding</h2>
<div class="highlight"><pre><code class="language-text" data-lang="text">           Server Received: 15:31:29:103         Server Sent: 15:31:30:530
           v                                     v
           +-------------------------------------+
           |  POST /thing                        | 1427ms
           +-------------------------------------+
                            | peer.ipv4           | 1.2.3.4                 |
                            | http.request-id     | abcd-ffe                |
                            | http.content.length | 15 MB                   |
                            | http.url            | ...&amp;features=HD-uploads |
</code></pre></div>
<blockquote>
<p>Ok, looks like this client is in the experimental group for HD uploads</p>

<p>I searched the logs for others in that group. took about the same time. </p>
</blockquote>

</div><div class="slide" id="slide13"><h2 id="there-39-s-often-two-sides-to-the-story">There&#39;s Often Two Sides to the Story</h2>
<div class="highlight"><pre><code class="language-text" data-lang="text">    Client Sent: 15:31:28:500                               Client Received: 15:31:31:000
    v                                                       v
    +-------------------------------------------------------+
    |  POST /some                                           | 2500ms
    +-------------------------------------------------------+
       +-------------------------------------+
       |  POST /thing                        | 1427ms
       +-------------------------------------+
       ^                                     ^
       Server Received: 15:31:29:103         Server Sent: 15:31:30:530
</code></pre></div>
</div><div class="slide" id="slide14"><h2 id="and-not-all-operations-are-on-the-critical-path">And Not All Operations are on the Critical Path</h2>
<div class="highlight"><pre><code class="language-text" data-lang="text">    +-------------------------------------------------------+
    |  POST /some                                           |
    +-------------------------------------------------------+
       +-------------------------------------+
       |  POST /thing                        |
       +-------------------------------------+
               +---------------------------+
               |  Sync Store               |
               +---------------------------+
                     +--------------------------------------------------------------+
                     |  Async Store                                                 |
                     +--------------------------------------------------------------+
</code></pre></div>
</div><div class="slide" id="slide15"><h2 id="distributed-tracing-adds-structure-to-correlation-data">Distributed Tracing adds structure to correlation data</h2>

<p>It&#39;s like centralized logging, but structured at source</p>

<ul>
<li><p>Well-known labels and identifiers</p></li>
<li><p>Indexed and queryable</p></li>
<li><p>Special purpose query servers and UIs</p></li>
</ul>

</div><div class="slide" id="slide16"><h2 id="distributed-tracing-commoditizes-knowledge">Distributed Tracing commoditizes knowledge</h2>

<p>Distributed tracing systems collect end-to-end
latency graphs (traces) in near real-time.</p>

<p>You can compare traces to understand why certain
requests take longer than others.</p>

</div><div class="slide" id="slide17"><h2 id="distributed-tracing-vocabulary">Distributed Tracing Vocabulary</h2>

<p>A <em>Span</em> is an individual operation that took place.</p>

<p>A <em>span</em> contains timestamped <em>events</em> and <em>tags</em>.</p>

<p>A <em>Trace</em> is an end-to-end latency graph, composed of <em>spans</em>.</p>

</div><div class="slide" id="slide18"><h2 id="in-a-picture">In a Picture</h2>
<div class="highlight"><pre><code class="language-text" data-lang="text">           Server Received: 15:31:29:103         Server Sent: 15:31:30:530
           v                                     v
           +-------------------------------------+
           |  POST /thing                        | 1427ms
           +-------------------------------------+
                            | peer.ipv4           | 1.2.3.4                |
                            | http.request-id     | abcd-ffe               |
                            | http.content.length | 15 MB                  |
                            | http.url            |...&amp;features=HD-uploads |
</code></pre></div>
<ul>
<li><p><em>POST /thing</em> is a <em>span name</em></p></li>
<li><p><em>427ms</em> is a <em>span duration</em></p></li>
<li><p><em>Server Received</em> is an <em>event</em> (with a timestamp)</p></li>
<li><p><em>http.request-id=abcd-ffe</em> is a <em>span tag</em></p></li>
</ul>

</div><div class="slide" id="slide19"><h2 id="tracers-send-trace-data-out-of-process">Tracers send trace data out of process</h2>

<blockquote>
<p>Tracers propagate IDs in-band,
to tell the receiver there&#39;s
a trace in progress</p>
</blockquote>

<p>Completed spans are reported out-of-band,
to reduce overhead and allow for batching</p>

</div><div class="slide" id="slide20"><h2 id="zipkin">Zipkin</h2>

<ul>
<li><p>Tracers collect timing data and transport it over HTTP or
Kafka or (via Spring Cloud) Rabbit.</p></li>
<li><p>Collectors store spans in MySQL or Cassandra (or in memory).</p></li>
<li><p>Users query for traces via Zipkin&#39;s Web UI or Api.</p></li>
</ul>

<style>
img[alt=ZipkinUI] { width: 50%; }
</style>

<p><img src="images/zipkin-ui.png" alt="ZipkinUI"></p>

</div><div class="slide" id="slide21"><h2 id="getting-started">Getting Started</h2>

<ul>
<li>Download the Zipkin JAR from Bintray (or Maven Central, <a href="http://repo1.maven.org/maven2/io/zipkin/zipkin-web/1.36.0/zipkin-web-1.36.0-all.jar">io.zipkin:zipkin-web:1.36.0:all@jar</a>):</li>
</ul>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ java -jar zipkin-server.jar
</code></pre></div>
<ul>
<li>Or:</li>
</ul>
<div class="highlight"><pre><code class="language-text" data-lang="text">@EnableZipkinServer
@SpringBootApplication
public class ZipkinServer {

...

}
</code></pre></div>
<hr>

<p>Then:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ curl -s localhost:9411/api/v1/services | jq .
[ &quot;service1&quot;, &quot;service2&quot; ]
</code></pre></div>
</div><div class="slide" id="slide22"><h2 id="spring-cloud-sleuth-and-zipkin">Spring Cloud Sleuth and Zipkin</h2>

<p>To instrument your application and have it send
span data to a collector:</p>

<ul>
<li><p>Add <em>spring-cloud-sleuth-zipkin</em> (HTTP transport)
or <em>spring-cloud-sleuth-stream</em> (messaging transport)</p></li>
<li><p>Optionally set <code>spring.sleuth.sampler.percentage</code>
(default 0.1)</p></li>
<li><p>Spans ahoy!</p></li>
</ul>

</div><div class="slide" id="slide23"><h2 id="links">Links</h2>

<ul>
<li><p>Sleuth: <a href="https://github.com/spring-cloud/spring-cloud-sleuth">https://github.com/spring-cloud/spring-cloud-sleuth</a></p></li>
<li><p>Zipkin: <a href="https://github.com/openzipkin/zipkin-java">https://github.com/openzipkin/zipkin-java</a></p></li>
<li><p>Gitter for Sleuth: <a href="https://gitter.im/spring-cloud/spring-cloud-sleuth">https://gitter.im/spring-cloud/spring-cloud-sleuth</a></p></li>
<li><p>Gitter for Zipkin: <a href="https://gitter.im/openzipkin/zipkin">https://gitter.im/openzipkin/zipkin</a></p></li>
<li><p>Spring IO Guides:  <a href="https://spring.io/guides">https://spring.io/guides</a></p></li>
<li><p>Get Started on Your Own:  <a href="https://start.spring.io">https://start.spring.io</a></p></li>
</ul>
</div>


<a href="#" class="deck-prev-link" title="Previous">&#8592;</a>
<a href="#" class="deck-next-link" title="Next">&#8594;</a>

<p id="footer" class="deck-status">
	<span class="deck-status-current"></span>/<span class="deck-status-total"></span>
</p>

<form action="." method="get" class="goto-form">
	<label for="goto-slide">Go to slide:</label>
	<input type="number" name="slidenum" id="goto-slide">
	<input type="submit" value="Go">
</form>

<a href="." title="Permalink to this slide" class="deck-permalink">#</a>

<script src="/deck.js/jquery-1.7.2.min.js"></script>
<script>window.jQuery || document.write('<script src="../deck.js/jquery.min.js"><\/script>')</script>

<!-- Deck Core and extensions -->
<script src="../deck.js/core/deck.core.js"></script>
<script src="../deck.js/extensions/menu/deck.menu.js"></script>
<script src="../deck.js/extensions/goto/deck.goto.js"></script>
<script src="../deck.js/extensions/status/deck.status.js"></script>
<script src="../deck.js/extensions/navigation/deck.navigation.js"></script>
<script src="../deck.js/extensions/hash/deck.hash.js"></script>

<script type="text/javascript">
$(function() {
	// Deck initialization
	$.deck('.slide');
	
	$('#style-themes').change(function() {
		$('#style-theme-link').attr('href', $(this).val());
	});
	
	$('#transition-themes').change(function() {
		$('#transition-theme-link').attr('href', $(this).val());
	});

    $('pre').click(function (){
	$(this).toggleClass('highlighted');
    });
});
</script>

</body>
</html>
