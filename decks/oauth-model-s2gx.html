<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js ie6" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->  <html class="no-js" lang="en"> <!--<![endif]-->
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	
	<title></title>
	
	<meta name="description" content="A jQuery library for modern HTML presentations">
	<meta name="viewport" content="width=1024, user-scalable=no">
	
	<!-- Core and extension CSS files -->
	<link rel="stylesheet" href="../deck.js/core/deck.core.css">
	<link rel="stylesheet" href="../deck.js/extensions/goto/deck.goto.css">
	<link rel="stylesheet" href="../deck.js/extensions/menu/deck.menu.css">
	<link rel="stylesheet" href="../deck.js/extensions/navigation/deck.navigation.css">
	<link rel="stylesheet" href="../deck.js/extensions/status/deck.status.css">
	<link rel="stylesheet" href="../deck.js/extensions/hash/deck.hash.css">
	<link rel="stylesheet" href="../css/syntax.css">
	
	<!-- Theme CSS files (menu swaps these out) -->
    <link rel="stylesheet" href="../font-awesome/css/font-awesome.css">
    
    
	<link rel="stylesheet" id="style-theme-link" href="../themes/style/springone13.css">
	<link rel="stylesheet" id="transition-theme-link" href="../deck.js/themes/transition/horizontal-slide.css">
	
	<script src="../deck.js/modernizr.custom.js"></script>
</head>

<body class="deck-container">

<div class="slide" id="slide1"><h1 id="toc_0">Data Modelling for OAuth2</h1>

<p>Dave Syer, 2013<br>
Twitter: @david_syer<br>
Email: <a href="mailto:dsyer@gopivotal.com">dsyer@gopivotal.com</a></p>

</div><div class="slide" id="slide2"><h2></h2>

<p><img src="images/spring-io-core.png" alt="Spring IO"></p>

</div><div class="slide" id="slide3"><h2 id="toc_1">Agenda</h2>

<ul>
<li>Quick overview of <a href="http://en.wikipedia.org/wiki/OAuth#OAuth_2.0">OAuth2</a>?</li>
<li>Data Modelling for OAuth2</li>
<li>Spring OAuth</li>
<li>Cloud Foundry <a href="http://github.com/cloudfoundry/uaa">UAA</a></li>
</ul>

</div><div class="slide" id="slide4"><h2 id="toc_2">Quick Introduction to OAuth2</h2>

<blockquote>
<p>A Client application, often web application, acts on behalf of a
User, but with the User&#39;s approval</p>
</blockquote>

<ul>
<li>Authorization Server</li>
<li>Resource Server</li>
<li>Client application</li>
</ul>

<p>Common examples of Authorization Servers on the internet:</p>

<ul>
<li><a href="http://developers.facebook.com">Facebook</a> - Graph API</li>
<li><a href="http://code.google.com/apis/accounts/docs/OAuth2.html">Google</a> - Google APIs</li>
<li><a href="http://uaa.run.pivotal.io">Cloud Foundry</a> - Cloud Controller</li>
</ul>

</div><div class="slide" id="slide5"><h2 id="toc_3">OAuth2 Key Features</h2>

<ul>
<li>Extremely simple for clients</li>
<li>Access tokens carry information (beyond identity)</li>
<li><p>Resource Servers are free to interpret tokens</p></li>
<li><p>Example token contents:</p>

<ul>
<li>Client id</li>
<li>Resource id (audience)</li>
<li>User id</li>
<li>Role assignments</li>
</ul></li>
</ul>

</div><div class="slide" id="slide6"><h2 id="toc_4">Obtaining a Client Token</h2>

<p>A client can act its own behalf (<code>client_credentials</code> grant):</p>

<p><img src="images/client-credentials-flow.png" alt="auth-code-flow"></p>

</div><div class="slide" id="slide7"><h2 id="toc_5">Web Application Client</h2>

<p>The Client wants to access a Resource on behalf of the User</p>

<p><img src="images/oauth-web-client.png" alt="oauth-web-client"></p>

</div><div class="slide" id="slide8"><h2 id="toc_6">Obtaining a User Token</h2>

<p>A client can act on behalf of a user (e.g. <code>authorization_code</code> grant):</p>

<p><img src="images/auth-code-flow.png" alt="auth-code-flow"></p>

</div><div class="slide" id="slide9"><h2 id="toc_7">Authorization Code Grant Summary</h2>

<ol>
<li><p>Authorization Server authenticates the User</p></li>
<li><p>Client starts the authorization flow and obtain User&#39;s approval</p></li>
<li><p>Authorization Server issues an authorization code (opaque one-time
token)</p></li>
<li><p>Client exchanges the authorization code for an access token.</p></li>
</ol>

</div><div class="slide" id="slide10"><h2 id="toc_8">OAuth2 Bearer Tokens</h2>

<p>Bearer tokens are authentication tokens for client applications. Once
you have one you can act on behalf of a user, accessing resources:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">$ curl -H &quot;Authorization: Bearer &lt;token&gt;&quot; resource.server.com/stuff
</code></pre></div>
<p><br/></p>

<p>The resource server treats the request as if it came from an
authenticated user.</p>

</div><div class="slide" id="slide11"><h2 id="toc_9">Role of Client Application</h2>

<ul>
<li>Register with Authorization Server (get a <code>client_id</code> and maybe a
<code>client_secret</code>)</li>
<li>Do not collect user credentials</li>
<li>Obtain a token (opaque) from Authorization Server

<ul>
<li>On its own behalf - <code>client_credentials</code></li>
<li>On behalf of a user</li>
</ul></li>
<li>Use it to access Resource Server</li>
</ul>

</div><div class="slide" id="slide12"><h2 id="toc_10">Role of Resource Server</h2>

<ol>
<li>Extract token from request and decode it</li>
<li>Make access control decision

<ul>
<li>Scope</li>
<li>Audience</li>
<li>User account information (id, roles etc.)</li>
<li>Client information (id, roles etc.)</li>
</ul></li>
<li>Send 403 (FORBIDDEN) if token not sufficient</li>
</ol>

</div><div class="slide" id="slide13"><h2 id="toc_11">Role of the Authorization Server</h2>

<ol>
<li>Compute token content and grant tokens</li>
<li>Interface for users to confirm that they authorize the Client to act
on their behalf</li>
<li>Authenticate users (<code>/authorize</code>)</li>
<li>Authenticate clients (<code>/token</code>)</li>
</ol>

<p>#1 and #4 are covered thoroughly by the spec; #2 and #3 not (for
good reasons).</p>

</div><div class="slide" id="slide14"><h2 id="toc_12">Spring Security OAuth2</h2>

<blockquote>
<p><em>Goal:</em> implement Resource Server, Authorization Server, and Client
Application with sensible defaults and plenty of customization
choices. Provides features for implementing both consumers and
providers of the OAuth protocols using standard Spring and Spring
Security programming models and configuration idioms.</p>
</blockquote>

<ul>
<li>1.0 = Nov 2012</li>
<li>1.0.5 = Aug 2013</li>
<li>1.1.0 = soon</li>
</ul>

</div><div class="slide" id="slide15"><h2 id="toc_13">Spring OAuth Responsibilities</h2>

<ul>
<li>Authorization Server: <code>AuthorizationEndpoint</code> and <code>TokenEndpoint</code></li>
<li>Resource Server: <code>OAuth2AuthenticationProcessingFilter</code></li>
<li>Client: <code>OAuth2RestTemplate</code>, <code>OAuth2ClientContextFilter</code></li>
</ul>

</div><div class="slide" id="slide16"><h2 id="toc_14">Spring as Resource Server</h2>

<p><img src="images/resource-server-endpoints.png" alt="resource-server-endpoints"></p>

</div><div class="slide" id="slide17"><h2 id="toc_15">Spring as Authorization Server</h2>

<p><img src="images/auth-server-endpoints.png" alt="auth-server-endpoints"></p>

</div><div class="slide" id="slide18"><h2 id="toc_16">Spring as Client Application</h2>

<p><img src="images/oauth-rest-template.png" alt="oauth-rest-template"></p>

</div><div class="slide" id="slide19"><h2 id="toc_17">OAuth2 Data Modelling</h2>

<ul>
<li>Token format</li>
<li>Token contents</li>
<li>Client registrations</li>
<li>Computing permissions</li>
<li>User approvals</li>
<li>User authentication</li>
</ul>

</div><div class="slide" id="slide20"><h2 id="toc_18">Token Format</h2>

<ul>
<li>OAuth 2.0 tokens are opaque to clients (so might be simple keys to a backend store)</li>
<li>But they carry important information to Resource Servers</li>
<li>Example implementation (from Cloud Foundry UAA, JWT = signed,
base64-encoded, JSON):</li>
</ul>
<div class="highlight"><pre><code class="json language-json" data-lang="json"><span class="p">{</span>  <span class="nt">&quot;client_id&quot;</span><span class="p">:</span><span class="s2">&quot;vmc&quot;</span><span class="p">,</span>
   <span class="nt">&quot;exp&quot;</span><span class="p">:</span><span class="mi">1346325625</span><span class="p">,</span>
   <span class="nt">&quot;scope&quot;</span><span class="p">:[</span><span class="s2">&quot;cloud_controller.read&quot;</span><span class="p">,</span><span class="s2">&quot;openid&quot;</span><span class="p">,</span><span class="s2">&quot;password.write&quot;</span><span class="p">],</span>
   <span class="nt">&quot;aud&quot;</span><span class="p">:[</span><span class="s2">&quot;openid&quot;</span><span class="p">,</span><span class="s2">&quot;cloud_controller&quot;</span><span class="p">,</span><span class="s2">&quot;password&quot;</span><span class="p">],</span>
   <span class="nt">&quot;user_name&quot;</span><span class="p">:</span><span class="s2">&quot;vcap_tester@vmware.com&quot;</span><span class="p">,</span>
   <span class="nt">&quot;user_id&quot;</span><span class="p">:</span><span class="s2">&quot;52147673-9d60-4674-a6d9-225b94d7a64e&quot;</span><span class="p">,</span>
   <span class="nt">&quot;email&quot;</span><span class="p">:</span><span class="s2">&quot;vcap_tester@vmware.com&quot;</span><span class="p">,</span>
 <span class="nt">&quot;jti&quot;</span><span class="p">:</span><span class="s2">&quot;f724ae9a-7c6f-41f2-9c4a-526cea84e614&quot;</span> <span class="p">}</span>
</code></pre></div>
</div><div class="slide" id="slide21"><h2 id="toc_19">Token Format Choices</h2>

<p>Resources decode through:</p>

<ol>
<li>Shared storage -&gt; opaque</li>
<li>Remote service (e.g. <code>/check_token</code>) -&gt; opaque</li>
<li>Resources decode locally -&gt; encoded + signed ( + possibly encrypted)</li>
</ol>

<p>#2 and #3 require key management infrastructure - resource server
and authorization server need to agree on signing (and possibly
encryption). Can be as simple as shared configuration file.</p>

</div><div class="slide" id="slide22"><h2 id="toc_20">Token Contents</h2>

<ul>
<li>Audience</li>
<li>Scope</li>
<li>Expiry</li>
<li>Client details</li>
<li>Other...</li>
</ul>

</div><div class="slide" id="slide23"><h2 id="toc_21">Token Audience</h2>

<p>Resource Servers should check if they are the intended recipient of a
token. No specific mechanism in OAuth2 spec.</p>

<p>In Spring OAuth every resource optionally has a &quot;resource ID&quot;. It is
copmared with the token in an authentication filter.</p>

<blockquote>
<p>For encoded tokens, e.g. JWT has a standard field <code>aud</code> for the
audience of the token.</p>
</blockquote>

</div><div class="slide" id="slide24"><h2 id="toc_22">Client Registration Data</h2>

<ul>
<li>Client id</li>
<li>Secret</li>
<li>Redirect URIs</li>
<li>Authorized grant types</li>
</ul>

</div><div class="slide" id="slide25"><h2 id="toc_23">Client Registration Scopes</h2>

<p>Clients often act on their own behalf (<code>client_credentials</code> grant),
and then the available scopes might be different.  In Cloud Foundry we
find it useful to distinguish between client scopes (for user tokens)
and authorities (for client tokens).</p>

<p><img src="images/client-scopes.png" alt="client-scopes"></p>

</div><div class="slide" id="slide26"><h2 id="toc_24">Client Registration Data</h2>

<p>Minimum</p>

<ul>
<li>Client id</li>
<li>Secret</li>
<li>Redirect URIs</li>
<li>Authorized grant types</li>
</ul>

<p>Desirable</p>

<ul>
<li>Authorities -&gt; scope for client token</li>
<li>Default scopes -&gt; scope for user token</li>
<li>Resource ids -&gt; audience</li>
<li>Owner of registration (e.g. a user)</li>
</ul>

</div><div class="slide" id="slide27"><h2 id="toc_25">More on Scopes</h2>

<p>Per the spec scopes are arbitrary strings.  The Authorization Server and
the Resource Servers agree on the content and meanings.</p>

<p>Examples:</p>

<ul>
<li>Google: <code>https://www.googleapis.com/auth/userinfo.profile</code></li>
<li>Facebook: <code>email</code>, <code>read_stream</code>, <code>write_stream</code></li>
<li>UAA: <code>cloud_controller.read</code>, <code>cloud_controller.write</code>, <code>scim.read</code>,
<code>openid</code></li>
</ul>

<p>Authorization Server has to decide whether to grant a token to a given
client and user based on the requested scope (if any).</p>

</div><div class="slide" id="slide28"><h2 id="toc_26">Simple Example of Computed Scopes</h2>

<ul>
<li>Client requests <code>scope=read,write</code></li>
<li>Auth server compares client <code>authorities=read</code></li>
<li>Grants token with narrower scope</li>
</ul>

<blockquote>
<p>Uses Spring Security concept of &quot;authorities&quot; attached to a client</p>

<p>Not implemented out of the box in Spring OAuth 1.0 (might be in 1.1)</p>
</blockquote>

</div><div class="slide" id="slide29"><h2 id="toc_27">Cloud Foundry Scope Computation</h2>

<p><em>Client Token</em></p>

<ul>
<li>If client requests no explicit scope: set to default value per client</li>
<li>Restrict to intersection with default scopes (per client)</li>
</ul>

<p><em>User Token</em></p>

<ul>
<li>If client requests no explicit scope: set to default value per client</li>
<li>Restrict to intersection with default scopes (per client)</li>
<li>Further restrict to intersection with user groups (same as scope names)</li>
</ul>

</div><div class="slide" id="slide30"><h2 id="toc_28">UAA Scopes</h2>

<ul>
<li>UAA scopes are actually Groups in the User accounts</li>
<li><p><code>GET /Groups</code>, <code>Get /Users/{id}</code></p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">{
  &quot;id&quot;: &quot;73ba999e-fc34-49eb-ac26-dc8be52c1d82&quot;,
  &quot;meta&quot;: {...},
  &quot;userName&quot;: &quot;marissa&quot;,
  &quot;groups&quot;: [
   ...
   {
      &quot;value&quot;: &quot;23a71835-c7ce-43ac-b511-c84d3ae8e788&quot;,
      &quot;display&quot;: &quot;uaa.user&quot;,
      &quot;membershipType&quot;: &quot;DIRECT&quot;
    }
  ],
}
</code></pre></div></li>
</ul>

</div><div class="slide" id="slide31"><h2 id="toc_29">User Approvals</h2>

<p>An access token represents a user approval:</p>

<p><img src="images/token-model.png" alt="token-model"></p>

</div><div class="slide" id="slide32"><h2 id="toc_30">User Approvals as Token</h2>

<p>An access token represents a user approval:</p>

<p><img src="images/token-as-approval.png" alt="token-as-approval"></p>

</div><div class="slide" id="slide33"><h2 id="toc_31">Formal Model for User Approvals</h2>

<p>It can be an advantage to store individual approvals independently
(e.g. for explicit revokes of individual scopes):</p>

<p><img src="images/token-with-approvals.png" alt=""></p>

</div><div class="slide" id="slide34"><h2 id="toc_32">Authentication and the Authorization Server</h2>

<ul>
<li>Authentication (checking user credentials) is orthogonal to
authorization (granting tokens)</li>
<li>They don&#39;t have to be handled in the same component of a large
system</li>
<li>Authentication is often deferred to existing systems (SSO)</li>
<li>Authorization Server has to be able to authenticate the OAuth
endpoints (<code>/authorize</code> and <code>/token</code>)</li>
<li>It <em>does not</em> have to collect credentials (except for
<code>grant_type=password</code>)</li>
</ul>

</div><div class="slide" id="slide35"><h2 id="toc_33">Cloud Foundry UAA Authorization Server</h2>

<p><img src="images/cf-uaa.png" alt="cf-uaa"></p>

</div><div class="slide" id="slide36"><h2 id="toc_34">Consumer Side User Authentication</h2>

<blockquote>
<p>Using OAuth2 for authentication (and SSO)</p>
</blockquote>

<p>Authorization Server (typically) provides <code>/userinfo</code> endpoint. Client
exchanges a bearer token for some information about the
user. Examples:</p>

<ul>
<li>Github: <a href="https://api.github.com/user">https://api.github.com/user</a></li>
<li>Facebook: <a href="https://graph.facebook.com/me">https://graph.facebook.com/me</a></li>
<li>Cloud Foundry: <a href="uaa.run.pivotal.io/userinfo">https://uaa.run.pivotal.io/userinfo</a></li>
</ul>

<p>Beware: no standard data format for user info.</p>

</div><div class="slide" id="slide37"><h2 id="toc_35">Spring OAuth Strategies</h2>

<ul>
<li><code>TokenEnhancer</code> - modify token contents</li>
<li><code>UserApprovalHandler</code> - decide if authorization request has been approved</li>
<li><code>AuthorizationRequestManager</code> (<code>OAuth2RequestFactory</code> and <code>OAuth2RequestValidator</code> in 1.1)</li>
<li><code>TokenStore</code> - backend store for opaque tokens</li>
<li><code>ApprovalStore</code> - new in 1.1</li>
</ul>

<p>Higher level:</p>

<ul>
<li><code>AuthorizationServerTokenServices</code> - create and refresh tokens</li>
<li><code>ResourceServerTokenServices</code> - decode token</li>
<li><code>ConsumerTokenServices</code> - manage token grants and revokes</li>
</ul>

</div><div class="slide" id="slide38"><h2 id="toc_36">UAA Strategies</h2>

<ul>
<li>Implementations of <code>UserApprovalHandler</code>, <code>*TokenServices</code>, <code>AuthorizationRequestManager</code></li>
<li><code>UaaUserDatabase</code></li>
<li><code>ScimUserProvisioning</code>, <code>ScimGroupProvisioning</code></li>
<li>Custom approvals layer (will be superseded by 1.1)</li>
<li>Autologin (<code>login-server</code>)</li>
</ul>

</div><div class="slide" id="slide39"><h2 id="toc_37">Other Token Types</h2>

<ul>
<li>OpenID connect. Simple view: add <code>id_token</code> to access token.</li>
<li>MAC Tokens. Simple view: sign token  with hash of request.</li>
</ul>

<p>Not to be confused with:</p>

<ul>
<li>grant types (e.g. exchange SAML assertion for token),</li>
<li>authentication channels (e.g. LDAP authentication for users)</li>
</ul>

</div><div class="slide" id="slide40"><h2 id="toc_38">Links</h2>

<ul>
<li><a href="http://projects.spring.io/spring-security-oauth">http://projects.spring.io/spring-security-oauth</a> Documentation</li>
<li><a href="http://github.com/springsource/spring-security-oauth">http://github.com/springsource/spring-security-oauth</a> Spring OAuth on Github</li>
<li><a href="http://github.com/cloudfoundry/uaa">http://github.com/cloudfoundry/uaa</a> UAA on Github (see <code>docs/</code> folder)</li>
<li><a href="http://blog.cloudfoundry.org">http://blog.cloudfoundry.org</a></li>
<li><a href="http://spring.io/blog">http://spring.io/blog</a></li>
<li><a href="http://dsyer.com/presos/decks/oauth-model-s2gx.html">http://dsyer.com/presos/decks/oauth-model-s2gx.html</a></li>
<li>Twitter: <code>@david_syer</code><br></li>
<li>Email: <a href="mailto:dsyer@gopivotal.com">dsyer@gopivotal.com</a></li>
</ul>
</div>


<a href="#" class="deck-prev-link" title="Previous">&#8592;</a>
<a href="#" class="deck-next-link" title="Next">&#8594;</a>

<p id="footer" class="deck-status">
	<span class="deck-status-current"></span>/<span class="deck-status-total"></span>
</p>

<form action="." method="get" class="goto-form">
	<label for="goto-slide">Go to slide:</label>
	<input type="number" name="slidenum" id="goto-slide">
	<input type="submit" value="Go">
</form>

<a href="." title="Permalink to this slide" class="deck-permalink">#</a>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.js"></script>
<script>window.jQuery || document.write('<script src="../deck.js/jquery.min.js"><\/script>')</script>

<!-- Deck Core and extensions -->
<script src="../deck.js/core/deck.core.js"></script>
<script src="../deck.js/extensions/menu/deck.menu.js"></script>
<script src="../deck.js/extensions/goto/deck.goto.js"></script>
<script src="../deck.js/extensions/status/deck.status.js"></script>
<script src="../deck.js/extensions/navigation/deck.navigation.js"></script>
<script src="../deck.js/extensions/hash/deck.hash.js"></script>

<script type="text/javascript">
$(function() {
	// Deck initialization
	$.deck('.slide');
	
	$('#style-themes').change(function() {
		$('#style-theme-link').attr('href', $(this).val());
	});
	
	$('#transition-themes').change(function() {
		$('#transition-theme-link').attr('href', $(this).val());
	});

    $('pre').click(function (){
	$(this).toggleClass('highlighted');
    });
});
</script>

</body>
</html>
